"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf3 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _assertThisInitialized2 = _interopRequireDefault(require("@babel/runtime/helpers/assertThisInitialized"));

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _react = _interopRequireDefault(require("react"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _theme = require("../../theme");

var _portal = require("../../portal");

var _stack = require("../../stack");

var _TextTableCell = _interopRequireDefault(require("./TextTableCell"));

var _TableCell = _interopRequireDefault(require("./TableCell"));

var _EditableCellField = _interopRequireDefault(require("./EditableCellField"));

var EditableCell =
/*#__PURE__*/
function (_React$PureComponent) {
  (0, _inherits2.default)(EditableCell, _React$PureComponent);

  function EditableCell() {
    var _getPrototypeOf2;

    var _this;

    (0, _classCallCheck2.default)(this, EditableCell);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = (0, _possibleConstructorReturn2.default)(this, (_getPrototypeOf2 = (0, _getPrototypeOf3.default)(EditableCell)).call.apply(_getPrototypeOf2, [this].concat(args)));
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "state", {
      value: _this.props.children
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "onMainRef", function (ref) {
      _this.mainRef = ref;
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "onOverlayRef", function (ref) {
      _this.overlayRef = ref;
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "handleDoubleClick", function () {
      if (_this.props.disabled || !_this.props.isSelectable) return;

      _this.setState({
        isEditing: true
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "handleKeyDown", function (e) {
      if (_this.props.disabled) return;
      var key = e.key;
      /**
       * When the user presses a character on the keyboard, use that character
       * as the value in the text field.
       */

      if (key.match(/^[a-z]{0,10}$/) && !e.metaKey && !e.ctrlKey && !e.altKey) {
        _this.setState({
          isEditing: true,
          value: key
        });
      } else if (key === 'Enter') {
        _this.setState({
          isEditing: true
        });
      }
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "handleFieldChangeComplete", function (value) {
      var _this$props = _this.props,
          onChange = _this$props.onChange,
          isSelectable = _this$props.isSelectable;
      var currentValue = _this.state.value;

      _this.setState({
        isEditing: false,
        value: value
      });

      if (currentValue !== value && typeof onChange === 'function') {
        onChange(value);
      }

      if (_this.mainRef && isSelectable) {
        _this.mainRef.focus();
      }
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "handleFieldCancel", function () {
      _this.setState({
        isEditing: false
      });
    });
    (0, _defineProperty2.default)((0, _assertThisInitialized2.default)((0, _assertThisInitialized2.default)(_this)), "handleClick", function () {
      _this.mainRef.focus();
    });
    return _this;
  }

  (0, _createClass2.default)(EditableCell, [{
    key: "render",
    value: function render() {
      var _this2 = this;

      var _this$props2 = this.props,
          children = _this$props2.children,
          theme = _this$props2.theme,
          size = _this$props2.size,
          disabled = _this$props2.disabled,
          placeholder = _this$props2.placeholder,
          isSelectable = _this$props2.isSelectable,
          _this$props2$textProp = _this$props2.textProps,
          textProps = _this$props2$textProp === void 0 ? {} : _this$props2$textProp,
          props = (0, _objectWithoutProperties2.default)(_this$props2, ["children", "theme", "size", "disabled", "placeholder", "isSelectable", "textProps"]);
      var _this$state = this.state,
          isEditing = _this$state.isEditing,
          value = _this$state.value;
      return _react.default.createElement(_react.default.Fragment, null, _react.default.createElement(_TextTableCell.default, (0, _extends2.default)({
        innerRef: this.onMainRef,
        isSelectable: isSelectable && !disabled,
        onClick: this.handleClick,
        onDoubleClick: this.handleDoubleClick,
        onKeyDown: this.handleKeyDown,
        cursor: disabled ? 'not-allowed' : isSelectable ? 'default' : 'text',
        textProps: (0, _objectSpread2.default)({
          size: size,
          opacity: disabled || !children && placeholder ? 0.5 : 1
        }, textProps)
      }, props), children ? children : placeholder), isEditing && _react.default.createElement(_portal.Portal, null, _react.default.createElement(_stack.Stack, null, function (zIndex) {
        return _react.default.createElement(_EditableCellField.default, {
          zIndex: zIndex,
          getTargetRef: function getTargetRef() {
            return _this2.mainRef;
          },
          value: value,
          onEscape: _this2.handleFieldEscape,
          onChangeComplete: _this2.handleFieldChangeComplete,
          onCancel: _this2.handleFieldCancel,
          size: size
        });
      })));
    }
  }], [{
    key: "getDerivedStateFromProps",
    value: function getDerivedStateFromProps(props, state) {
      if (props.children !== state.value) {
        return {
          value: props.children
        };
      }

      return null;
    }
  }]);
  return EditableCell;
}(_react.default.PureComponent);

EditableCell.displayName = "EditableCell";
(0, _defineProperty2.default)(EditableCell, "propTypes", (0, _objectSpread2.default)({}, _TableCell.default.propTypes, {
  /*
  * Makes the TableCell focusable.
  * Will add tabIndex={-1 || this.props.tabIndex}.
  */
  isSelectable: _propTypes.default.bool.isRequired,

  /**
   * When true, the cell can't be edited.
   */
  disabled: _propTypes.default.bool,

  /**
   * Optional placeholder when children is falsy.
   */
  placeholder: _propTypes.default.node,

  /**
   * The size used for the TextTableCell and Textarea.
   */
  size: _propTypes.default.oneOf([300, 400]).isRequired,

  /**
   * This is the value of the cell.
   */
  children: _propTypes.default.oneOfType([_propTypes.default.string, _propTypes.default.number]),

  /**
   * Function called when value changes. (value: string) => void.
   */
  onChange: _propTypes.default.func
}));
(0, _defineProperty2.default)(EditableCell, "defaultProps", {
  size: 300,
  isSelectable: true
});

var _default = (0, _theme.withTheme)(EditableCell);

exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy90YWJsZS9zcmMvRWRpdGFibGVDZWxsLmpzIl0sIm5hbWVzIjpbIkVkaXRhYmxlQ2VsbCIsInZhbHVlIiwicHJvcHMiLCJjaGlsZHJlbiIsInJlZiIsIm1haW5SZWYiLCJvdmVybGF5UmVmIiwiZGlzYWJsZWQiLCJpc1NlbGVjdGFibGUiLCJzZXRTdGF0ZSIsImlzRWRpdGluZyIsImUiLCJrZXkiLCJtYXRjaCIsIm1ldGFLZXkiLCJjdHJsS2V5IiwiYWx0S2V5Iiwib25DaGFuZ2UiLCJjdXJyZW50VmFsdWUiLCJzdGF0ZSIsImZvY3VzIiwidGhlbWUiLCJzaXplIiwicGxhY2Vob2xkZXIiLCJ0ZXh0UHJvcHMiLCJvbk1haW5SZWYiLCJoYW5kbGVDbGljayIsImhhbmRsZURvdWJsZUNsaWNrIiwiaGFuZGxlS2V5RG93biIsIm9wYWNpdHkiLCJ6SW5kZXgiLCJoYW5kbGVGaWVsZEVzY2FwZSIsImhhbmRsZUZpZWxkQ2hhbmdlQ29tcGxldGUiLCJoYW5kbGVGaWVsZENhbmNlbCIsIlJlYWN0IiwiUHVyZUNvbXBvbmVudCIsIlRhYmxlQ2VsbCIsInByb3BUeXBlcyIsIlByb3BUeXBlcyIsImJvb2wiLCJpc1JlcXVpcmVkIiwibm9kZSIsIm9uZU9mIiwib25lT2ZUeXBlIiwic3RyaW5nIiwibnVtYmVyIiwiZnVuYyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7SUFFTUEsWTs7Ozs7Ozs7Ozs7Ozs7Ozs7OEhBcURJO0FBQ05DLE1BQUFBLEtBQUssRUFBRSxNQUFLQyxLQUFMLENBQVdDO0FBRFosSztrSUFJSSxVQUFBQyxHQUFHLEVBQUk7QUFDakIsWUFBS0MsT0FBTCxHQUFlRCxHQUFmO0FBQ0QsSztxSUFFYyxVQUFBQSxHQUFHLEVBQUk7QUFDcEIsWUFBS0UsVUFBTCxHQUFrQkYsR0FBbEI7QUFDRCxLOzBJQUVtQixZQUFN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QUFBLElBQUksRUFBRWdCLG1CQUFVSSxLQUFWLENBQWdCLENBQUMsR0FBRCxFQUFNLEdBQU4sQ0FBaEIsRUFBNEJGLFU7O0FBRWxDOzs7QUFHQXJDLEVBQUFBLFFBQVEsRUFBRW1DLG1CQUFVSyxTQUFWLENBQW9CLENBQUNMLG1CQUFVTSxNQUFYLEVBQW1CTixtQkFBVU8sTUFBN0IsQ0FBcEIsQzs7QUFFVjs7O0FBR0E1QixFQUFBQSxRQUFRLEVBQUVxQixtQkFBVVE7OzhCQXBDbEI5QyxZLGtCQXVDa0I7QUFDcEJzQixFQUFBQSxJQUFJLEVBQUUsR0FEYztBQUVwQmQsRUFBQUEsWUFBWSxFQUFFO0FBRk0sQzs7ZUFxSVQsc0JBQVVSLFlBQVYsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCBmcm9tICdyZWFjdCdcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcydcbmltcG9ydCB7IHdpdGhUaGVtZSB9IGZyb20gJy4uLy4uL3RoZW1lJ1xuaW1wb3J0IHsgUG9ydGFsIH0gZnJvbSAnLi4vLi4vcG9ydGFsJ1xuaW1wb3J0IHsgU3RhY2sgfSBmcm9tICcuLi8uLi9zdGFjaydcbmltcG9ydCBUZXh0VGFibGVDZWxsIGZyb20gJy4vVGV4dFRhYmxlQ2VsbCdcbmltcG9ydCBUYWJsZUNlbGwgZnJvbSAnLi9UYWJsZUNlbGwnXG5pbXBvcnQgRWRpdGFibGVDZWxsRmllbGQgZnJvbSAnLi9FZGl0YWJsZUNlbGxGaWVsZCdcblxuY2xhc3MgRWRpdGFibGVDZWxsIGV4dGVuZHMgUmVhY3QuUHVyZUNvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgLyoqXG4gICAgICogQ29tcG9zZXMgdGhlIFRhYmxlQ2VsbCBjb21wb25lbnQgYXMgdGhlIGJhc2UuXG4gICAgICovXG4gICAgLi4uVGFibGVDZWxsLnByb3BUeXBlcyxcblxuICAgIC8qXG4gICAgKiBNYWtlcyB0aGUgVGFibGVDZWxsIGZvY3VzYWJsZS5cbiAgICAqIFdpbGwgYWRkIHRhYkluZGV4PXstMSB8fCB0aGlzLnByb3BzLnRhYkluZGV4fS5cbiAgICAqL1xuICAgIGlzU2VsZWN0YWJsZTogUHJvcFR5cGVzLmJvb2wuaXNSZXF1aXJlZCxcblxuICAgIC8qKlxuICAgICAqIFdoZW4gdHJ1ZSwgdGhlIGNlbGwgY2FuJ3QgYmUgZWRpdGVkLlxuICAgICAqL1xuICAgIGRpc2FibGVkOiBQcm9wVHlwZXMuYm9vbCxcblxuICAgIC8qKlxuICAgICAqIE9wdGlvbmFsIHBsYWNlaG9sZGVyIHdoZW4gY2hpbGRyZW4gaXMgZmFsc3kuXG4gICAgICovXG4gICAgcGxhY2Vob2xkZXI6IFByb3BUeXBlcy5ub2RlLFxuXG4gICAgLyoqXG4gICAgICogVGhlIHNpemUgdXNlZCBmb3IgdGhlIFRleHRUYWJsZUNlbGwgYW5kIFRleHRhcmVhLlxuICAgICAqL1xuICAgIHNpemU6IFByb3BUeXBlcy5vbmVPZihbMzAwLCA0MDBdKS5pc1JlcXVpcmVkLFxuXG4gICAgLyoqXG4gICAgICogVGhpcyBpcyB0aGUgdmFsdWUgb2YgdGhlIGNlbGwuXG4gICAgICovXG4gICAgY2hpbGRyZW46IFByb3BUeXBlcy5vbmVPZlR5cGUoW1Byb3BUeXBlcy5zdHJpbmcsIFByb3BUeXBlcy5udW1iZXJdKSxcblxuICAgIC8qKlxuICAgICAqIEZ1bmN0aW9uIGNhbGxlZCB3aGVuIHZhbHVlIGNoYW5nZXMuICh2YWx1ZTogc3RyaW5nKSA9PiB2b2lkLlxuICAgICAqL1xuICAgIG9uQ2hhbmdlOiBQcm9wVHlwZXMuZnVuY1xuICB9XG5cbiAgc3RhdGljIGRlZmF1bHRQcm9wcyA9IHtcbiAgICBzaXplOiAzMDAsXG4gICAgaXNTZWxlY3RhYmxlOiB0cnVlXG4gIH1cblxuICBzdGF0aWMgZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKHByb3BzLCBzdGF0ZSkge1xuICAgIGlmIChwcm9wcy5jaGlsZHJlbiAhPT0gc3RhdGUudmFsdWUpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbHVlOiBwcm9wcy5jaGlsZHJlblxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gbnVsbFxuICB9XG5cbiAgc3RhdGUgPSB7XG4gICAgdmFsdWU6IHRoaXMucHJvcHMuY2hpbGRyZW5cbiAgfVxuXG4gIG9uTWFpblJlZiA9IHJlZiA9PiB7XG4gICAgdGhpcy5tYWluUmVmID0gcmVmXG4gIH1cblxuICBvbk92ZXJsYXlSZWYgPSByZWYgPT4ge1xuICAgIHRoaXMub3ZlcmxheVJlZiA9IHJlZlxuICB9XG5cbiAgaGFuZGxlRG91YmxlQ2xpY2sgPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMucHJvcHMuZGlzYWJsZWQgfHwgIXRoaXMucHJvcHMuaXNTZWxlY3RhYmxlKSByZXR1cm5cblxuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgaXNFZGl0aW5nOiB0cnVlXG4gICAgfSlcbiAgfVxuXG4gIGhhbmRsZUtleURvd24gPSBlID0+IHtcbiAgICBpZiAodGhpcy5wcm9wcy5kaXNhYmxlZCkgcmV0dXJuXG4gICAgY29uc3QgeyBrZXkgfSA9IGVcblxuICAgIC8qKlxuICAgICAqIFdoZW4gdGhlIHVzZXIgcHJlc3NlcyBhIGNoYXJhY3RlciBvbiB0aGUga2V5Ym9hcmQsIHVzZSB0aGF0IGNoYXJhY3RlclxuICAgICAqIGFzIHRoZSB2YWx1ZSBpbiB0aGUgdGV4dCBmaWVsZC5cbiAgICAgKi9cbiAgICBpZiAoa2V5Lm1hdGNoKC9eW2Etel17MCwxMH0kLykgJiYgIWUubWV0YUtleSAmJiAhZS5jdHJsS2V5ICYmICFlLmFsdEtleSkge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIGlzRWRpdGluZzogdHJ1ZSxcbiAgICAgICAgdmFsdWU6IGtleVxuICAgICAgfSlcbiAgICB9IGVsc2UgaWYgKGtleSA9PT0gJ0VudGVyJykge1xuICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgIGlzRWRpdGluZzogdHJ1ZVxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBoYW5kbGVGaWVsZENoYW5nZUNvbXBsZXRlID0gdmFsdWUgPT4ge1xuICAgIGNvbnN0IHsgb25DaGFuZ2UsIGlzU2VsZWN0YWJsZSB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IGN1cnJlbnRWYWx1ZSA9IHRoaXMuc3RhdGUudmFsdWVcblxuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgaXNFZGl0aW5nOiBmYWxzZSxcbiAgICAgIHZhbHVlXG4gICAgfSlcblxuICAgIGlmIChjdXJyZW50VmFsdWUgIT09IHZhbHVlICYmIHR5cGVvZiBvbkNoYW5nZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgb25DaGFuZ2UodmFsdWUpXG4gICAgfVxuXG4gICAgaWYgKHRoaXMubWFpblJlZiAmJiBpc1NlbGVjdGFibGUpIHtcbiAgICAgIHRoaXMubWFpblJlZi5mb2N1cygpXG4gICAgfVxuICB9XG5cbiAgaGFuZGxlRmllbGRDYW5jZWwgPSAoKSA9PiB7XG4gICAgdGhpcy5zZXRTdGF0ZSh7IGlzRWRpdGluZzogZmFsc2UgfSlcbiAgfVxuXG4gIGhhbmRsZUNsaWNrID0gKCkgPT4ge1xuICAgIHRoaXMubWFpblJlZi5mb2N1cygpXG4gIH1cblxuICByZW5kZXIoKSB7XG4gICAgY29uc3Qge1xuICAgICAgY2hpbGRyZW4sXG4gICAgICB0aGVtZSxcbiAgICAgIHNpemUsXG4gICAgICBkaXNhYmxlZCxcbiAgICAgIHBsYWNlaG9sZGVyLFxuICAgICAgaXNTZWxlY3RhYmxlLFxuICAgICAgdGV4dFByb3BzID0ge30sXG4gICAgICAuLi5wcm9wc1xuICAgIH0gPSB0aGlzLnByb3BzXG4gICAgY29uc3QgeyBpc0VkaXRpbmcsIHZhbHVlIH0gPSB0aGlzLnN0YXRlXG5cbiAgICByZXR1cm4gKFxuICAgICAgPFJlYWN0LkZyYWdtZW50PlxuICAgICAgICA8VGV4dFRhYmxlQ2VsbFxuICAgICAgICAgIGlubmVyUmVmPXt0aGlzLm9uTWFpblJlZn1cbiAgICAgICAgICBpc1NlbGVjdGFibGU9e2lzU2VsZWN0YWJsZSAmJiAhZGlzYWJsZWR9XG4gICAgICAgICAgb25DbGljaz17dGhpcy5oYW5kbGVDbGlja31cbiAgICAgICAgICBvbkRvdWJsZUNsaWNrPXt0aGlzLmhhbmRsZURvdWJsZUNsaWNrfVxuICAgICAgICAgIG9uS2V5RG93bj17dGhpcy5oYW5kbGVLZXlEb3dufVxuICAgICAgICAgIGN1cnNvcj17ZGlzYWJsZWQgPyAnbm90LWFsbG93ZWQnIDogaXNTZWxlY3RhYmxlID8gJ2RlZmF1bHQnIDogJ3RleHQnfVxuICAgICAgICAgIHRleHRQcm9wcz17e1xuICAgICAgICAgICAgc2l6ZSxcbiAgICAgICAgICAgIG9wYWNpdHk6IGRpc2FibGVkIHx8ICghY2hpbGRyZW4gJiYgcGxhY2Vob2xkZXIpID8gMC41IDogMSxcbiAgICAgICAgICAgIC4uLnRleHRQcm9wc1xuICAgICAgICAgIH19XG4gICAgICAgICAgey4uLnByb3BzfVxuICAgICAgICA+XG4gICAgICAgICAge2NoaWxkcmVuID8gY2hpbGRyZW4gOiBwbGFjZWhvbGRlcn1cbiAgICAgICAgPC9UZXh0VGFibGVDZWxsPlxuICAgICAgICB7aXNFZGl0aW5nICYmIChcbiAgICAgICAgICA8UG9ydGFsPlxuICAgICAgICAgICAgPFN0YWNrPlxuICAgICAgICAgICAgICB7ekluZGV4ID0+IChcbiAgICAgICAgICAgICAgICA8RWRpdGFibGVDZWxsRmllbGRcbiAgICAgICAgICAgICAgICAgIHpJbmRleD17ekluZGV4fVxuICAgICAgICAgICAgICAgICAgZ2V0VGFyZ2V0UmVmPXsoKSA9PiB0aGlzLm1haW5SZWZ9XG4gICAgICAgICAgICAgICAgICB2YWx1ZT17dmFsdWV9XG4gICAgICAgICAgICAgICAgICBvbkVzY2FwZT17dGhpcy5oYW5kbGVGaWVsZEVzY2FwZX1cbiAgICAgICAgICAgICAgICAgIG9uQ2hhbmdlQ29tcGxldGU9e3RoaXMuaGFuZGxlRmllbGRDaGFuZ2VDb21wbGV0ZX1cbiAgICAgICAgICAgICAgICAgIG9uQ2FuY2VsPXt0aGlzLmhhbmRsZUZpZWxkQ2FuY2VsfVxuICAgICAgICAgICAgICAgICAgc2l6ZT17c2l6ZX1cbiAgICAgICAgICAgICAgICAvPlxuICAgICAgICAgICAgICApfVxuICAgICAgICAgICAgPC9TdGFjaz5cbiAgICAgICAgICA8L1BvcnRhbD5cbiAgICAgICAgKX1cbiAgICAgIDwvUmVhY3QuRnJhZ21lbnQ+XG4gICAgKVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHdpdGhUaGVtZShFZGl0YWJsZUNlbGwpXG4iXX0=
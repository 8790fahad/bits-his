import _extends from "@babel/runtime/helpers/esm/extends";
import _objectWithoutProperties from "@babel/runtime/helpers/esm/objectWithoutProperties";
import _classCallCheck from "@babel/runtime/helpers/esm/classCallCheck";
import _createClass from "@babel/runtime/helpers/esm/createClass";
import _possibleConstructorReturn from "@babel/runtime/helpers/esm/possibleConstructorReturn";
import _getPrototypeOf from "@babel/runtime/helpers/esm/getPrototypeOf";
import _inherits from "@babel/runtime/helpers/esm/inherits";
import _assertThisInitialized from "@babel/runtime/helpers/esm/assertThisInitialized";
import _defineProperty from "@babel/runtime/helpers/esm/defineProperty";
import React, { PureComponent } from 'react';
import PropTypes from 'prop-types';
import fuzzaldrin from 'fuzzaldrin-plus';
import VirtualList from 'react-tiny-virtual-list';
import { Pane } from '../../layers';
import { TableHead, SearchTableHeaderCell } from '../../table';
import OptionShapePropType from './OptionShapePropType';
import Option from './Option';
/**
 * Fuzzaldrin-plus is the default filter, but you can use your own
 * as long as they follow the following signature:
 * @param options <Array[String]> - ['label', 'label2', ...]
 * @param input <String>
 */

var fuzzyFilter = function fuzzyFilter(options, input) {
  return fuzzaldrin.filter(options, input);
};
/**
 * This is the default item renderer of options
 * you can pass custom renderers as long as they work the same as the Option
 */


var itemRenderer = function itemRenderer(props) {
  return React.createElement(Option, props);
};

itemRenderer.displayName = "itemRenderer";

var OptionsList =
/*#__PURE__*/
function (_PureComponent) {
  _inherits(OptionsList, _PureComponent);

  function OptionsList(props, context) {
    var _this;

    _classCallCheck(this, OptionsList);

    _this = _possibleConstructorReturn(this, _getPrototypeOf(OptionsList).call(this, props, context));

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "isSelected", function (item) {
      var selected = _this.state.selected;
      return Boolean(selected.find(function (selectedItem) {
        return selectedItem === item.value;
      }));
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "search", function (options) {
      var optionsFilter = _this.props.optionsFilter;
      var searchValue = _this.state.searchValue;
      return searchValue.trim() === '' ? options // Return if no search query
      : optionsFilter(options.map(function (item) {
        return item.labelInList || item.label;
      }), searchValue).map(function (name) {
        return options.find(function (item) {
          return item.labelInList === name || item.label === name;
        });
      });
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "getCurrentIndex", function () {
      var selected = _this.props.selected;

      var options = _this.getFilteredOptions();

      return options.findIndex(function (option) {
        return option.value === selected[selected.length - 1];
      });
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleKeyDown", function (e) {
      if (e.keyCode === 38) {
        _this.handleArrowUp();
      }

      if (e.keyCode === 40) {
        _this.handleArrowDown();
      }

      if (e.keyCode === 13) {
        _this.handleEnter();
      }
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleArrowUp", function () {
      var onSelect = _this.props.onSelect;

      var options = _this.getFilteredOptions();

      var nextIndex = _this.getCurrentIndex() - 1;

      if (nextIndex < 0) {
        nextIndex = options.length - 1;
      }

      onSelect(options[nextIndex]);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleArrowDown", function () {
      var onSelect = _this.props.onSelect;

      var options = _this.getFilteredOptions();

      var nextIndex = _this.getCurrentIndex() + 1;

      if (nextIndex === options.length) {
        nextIndex = 0;
      }

      onSelect(options[nextIndex]);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleEnter", function () {
      var isSelected = _this.getCurrentIndex() !== -1;

      if (isSelected) {
        _this.props.close();
      }
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleChange", function (searchValue) {
      _this.setState({
        searchValue: searchValue
      });
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleSelect", function (item) {
      _this.props.onSelect(item);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "handleDeselect", function (item) {
      _this.props.onDeselect(item);
    });

    _defineProperty(_assertThisInitialized(_assertThisInitialized(_this)), "assignSearchRef", function (ref) {
      _this.searchRef = ref;
    });

    _this.state = {
      searchValue: props.defaultSearchValue,
      selected: props.selected
    };
    return _this;
  }

  _createClass(OptionsList, [{
    key: "componentDidMount",
    value: function componentDidMount() {
      var _this2 = this;

      var hasFilter = this.props.hasFilter;
      if (!hasFilter) return;
      /**
       * Hacky solution for broken autoFocus
       * https://github.com/segmentio/evergreen/issues/90
       */

      requestAnimationFrame(function () {
        _this2.searchRef.querySelector('input').focus();
      });
      window.addEventListener('keydown', this.handleKeyDown);
    }
  }, {
    key: "componentWillUnmount",
    value: function componentWillUnmount() {
      window.removeEventListener('keydown', this.handleKeyDown);
    }
  }, {
    key: "componentWillReceiveProps",
    value: function componentWillReceiveProps(nextProps) {
      if (nextProps.selected !== this.state.selected) {
        this.setState({
          selected: nextProps.selected
        });
      }
    }
  }, {
    key: "getFilteredOptions",
    value: function getFilteredOptions() {
      var options = this.props.options;
      return this.search(options);
    }
  }, {
    key: "render",
    value: function render() {
      var _this3 = this;

      var _this$props = this.props,
          originalOptions = _this$props.options,
          close = _this$props.close,
          width = _this$props.width,
          height = _this$props.height,
          onSelect = _this$props.onSelect,
          onDeselect = _this$props.onDeselect,
          selected = _this$props.selected,
          hasFilter = _this$props.hasFilter,
          optionSize = _this$props.optionSize,
          _renderItem = _this$props.renderItem,
          placeholder = _this$props.placeholder,
          optionsFilter = _this$props.optionsFilter,
          isMultiSelect = _this$props.isMultiSelect,
          defaultSearchValue = _this$props.defaultSearchValue,
          props = _objectWithoutProperties(_this$props, ["options", "close", "width", "height", "onSelect", "onDeselect", "selected", "hasFilter", "optionSize", "renderItem", "placeholder", "optionsFilter", "isMultiSelect", "defaultSearchValue"]);

      var options = this.search(originalOptions);
      var listHeight = height - (hasFilter ? 32 : 0);
      var currentIndex = this.getCurrentIndex();
      var scrollToIndex = currentIndex === -1 ? 0 : currentIndex;
      return React.createElement(Pane, _extends({
        height: height,
        width: width,
        display: "flex",
        flexDirection: "column"
      }, props), hasFilter && React.createElement(TableHead, null, React.createElement(SearchTableHeaderCell, {
        onChange: this.handleChange,
        innerRef: this.assignSearchRef,
        borderRight: null,
        height: 32
      })), React.createElement(Pane, {
        flex: 1
      }, React.createElement(VirtualList, _extends({
        height: listHeight,
        width: "100%",
        itemSize: optionSize,
        itemCount: options.length,
        overscanCount: 20,
        scrollToAlignment: "auto"
      }, scrollToIndex ? {
        scrollToIndex: scrollToIndex
      } : {}, {
        renderItem: function renderItem(_ref) {
          var index = _ref.index,
              style = _ref.style;
          var item = options[index];

          var isSelected = _this3.isSelected(item);

          return _renderItem({
            key: item.value,
            label: item.label,
            style: style,
            height: optionSize,
            onSelect: function onSelect() {
              return _this3.handleSelect(item);
            },
            onDeselect: function onDeselect() {
              return _this3.handleDeselect(item);
            },
            isSelectable: !isSelected || isMultiSelect,
            isSelected: isSelected
          });
        }
      }))));
    }
  }]);

  return OptionsList;
}(PureComponent);

OptionsList.displayName = "OptionsList";

_defineProperty(OptionsList, "propTypes", {
  options: PropTypes.arrayOf(OptionShapePropType),
  close: PropTypes.func,
  height: PropTypes.number,
  width: PropTypes.number,

  /**
   * When true, multi select is accounted for.
   */
  isMultiSelect: PropTypes.bool,

  /**
   * This holds the values of the options
   */
  selected: PropTypes.arrayOf(PropTypes.string),
  onSelect: PropTypes.func,
  onDeselect: PropTypes.func,
  hasFilter: PropTypes.bool,
  optionSize: PropTypes.number,
  renderItem: PropTypes.func,
  placeholder: PropTypes.string,
  optionsFilter: PropTypes.func,
  defaultSearchValue: PropTypes.string
});

_defineProperty(OptionsList, "defaultProps", {
  options: [],

  /**
   * Including border bottom
   * For some reason passing height to TableRow doesn't work
   * TODO: fix hacky solution
   */
  optionSize: 33,
  onSelect: function onSelect() {},
  onDeselect: function onDeselect() {},
  selected: [],
  renderItem: itemRenderer,
  optionsFilter: fuzzyFilter,
  placeholder: 'Filter...',
  defaultSearchValue: ''
});

export { OptionsList as default };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZWxlY3QtbWVudS9zcmMvT3B0aW9uc0xpc3QuanMiXSwibmFtZXMiOlsiUmVhY3QiLCJQdXJlQ29tcG9uZW50IiwiUHJvcFR5cGVzIiwiZnV6emFsZHJpbiIsIlZpcnR1YWxMaXN0IiwiUGFuZSIsIlRhYmxlSGVhZCIsIlNlYXJjaFRhYmxlSGVhZGVyQ2VsbCIsIk9wdGlvblNoYXBlUHJvcFR5cGUiLCJPcHRpb24iLCJmdXp6eUZpbHRlciIsIm9wdGlvbnMiLCJpbnB1dCIsImZpbHRlciIsIml0ZW1SZW5kZXJlciIsInByb3BzIiwiT3B0aW9uc0xpc3QiLCJjb250ZXh0IiwiaXRlbSIsInNlbGVjdGVkIiwic3RhdGUiLCJCb29sZWFuIiwiZmluZCIsInNlbGVjdGVkSXRlbSIsInZhbHVlIiwib3B0aW9uc0ZpbHRlciIsInNlYXJjaFZhbHVlIiwidHJpbSIsIm1hcCIsImxhYmVsSW5MaXN0IiwibGFiZWwiLCJuYW1lIiwiZ2V0RmlsdGVyZWRPcHRpb25zIiwiZmluZEluZGV4Iiwib3B0aW9uIiwibGVuZ3RoIiwiZSIsImtleUNvZGUiLCJoYW5kbGVBcnJvd1VwIiwiaGFuZGxlQXJyb3dEb3duIiwiaGFuZGxlRW50ZXIiLCJvblNlbGVjdCIsIm5leHRJbmRleCIsImdldEN1cnJlbnRJbmRleCIsImlzU2VsZWN0ZWQiLCJjbG9zZSIsInNldFN0YXRlIiwib25EZXNlbGVjdCIsInJlZiIsInNlYXJjaFJlZiIsImRlZmF1bHRTZWFyY2hWYWx1ZSIsImhhc0ZpbHRlciIsInJlcXVlc3RBbmltYXRpb25GcmFtZSIsInF1ZXJ5U2VsZWN0b3IiLCJmb2N1cyIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJoYW5kbGVLZXlEb3duIiwicmVtb3ZlRXZlbnRMaXN0ZW5lciIsIm5leHRQcm9wcyIsInNlYXJjaCIsIm9yaWdpbmFsT3B0aW9ucyIsIndpZHRoIiwiaGVpZ2h0Iiwib3B0aW9uU2l6ZSIsInJlbmRlckl0ZW0iLCJwbGFjZWhvbGRlciIsImlzTXVsdGlTZWxlY3QiLCJsaXN0SGVpZ2h0IiwiY3VycmVudEluZGV4Iiwic2Nyb2xsVG9JbmRleCIsImhhbmRsZUNoYW5nZSIsImFzc2lnblNlYXJjaFJlZiIsImluZGV4Iiwic3R5bGUiLCJrZXkiLCJoYW5kbGVTZWxlY3QiLCJoYW5kbGVEZXNlbGVjdCIsImlzU2VsZWN0YWJsZSIsImFycmF5T2YiLCJmdW5jIiwibnVtYmVyIiwiYm9vbCIsInN0cmluZyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBT0EsS0FBUCxJQUFnQkMsYUFBaEIsUUFBcUMsT0FBckM7QUFDQSxPQUFPQyxTQUFQLE1BQXNCLFlBQXRCO0FBQ0EsT0FBT0MsVUFBUCxNQUF1QixpQkFBdkI7QUFDQSxPQUFPQyxXQUFQLE1BQXdCLHlCQUF4QjtBQUNBLFNBQVNDLElBQVQsUUFBcUIsY0FBckI7QUFDQSxTQUFTQyxTQUFULEVBQW9CQyxxQkFBcEIsUUFBaUQsYUFBakQ7QUFDQSxPQUFPQyxtQkFBUCxNQUFnQyx1QkFBaEM7QUFDQSxPQUFPQyxNQUFQLE1BQW1CLFVBQW5CO0FBRUE7Ozs7Ozs7QUFNQSxJQUFNQyxXQUFXLEdBQUcsU0FBZEEsV0FBYyxDQUFDQyxPQUFELEVBQVVDLEtBQVY7QUFBQSxTQUFvQlQsVUFBVSxDQUFDVSxNQUFYLENBQWtCRixPQUFsQixFQUEyQkMsS0FBM0IsQ0FBcEI7QUFBQSxDQUFwQjtBQUVBOzs7Ozs7QUFJQSxJQUFNRSxZQUFZLEdBQUcsU0FBZkEsWUFBZSxDQUFBQyxLQUFLO0FBQUEsU0FBSSxvQkFBQyxNQUFELEVBQVlBLEtBQVosQ0FBSjtBQUFBLENBQTFCOztBQUFNRCxZOztJQUVlRSxXOzs7OztBQTJDbkIsdUJBQVlELEtBQVosRUFBbUJFLE9BQW5CLEVBQTRCO0FBQUE7O0FBQUE7O0FBQzFCLHFGQUFNRixLQUFOLEVBQWFFLE9BQWI7O0FBRDBCLHlGQW1DZixVQUFBQyxJQUFJLEVBQUk7QUFBQSxVQUNYQyxRQURXLEdBQ0UsTUFBS0MsS0FEUCxDQUNYRCxRQURXO0FBR25C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QUUvRCxTQUFTLENBQUM4RSxJQW5CTDtBQW9CakJkLEVBQUFBLFdBQVcsRUFBRWhFLFNBQVMsQ0FBQ2lGLE1BcEJOO0FBcUJqQjFELEVBQUFBLGFBQWEsRUFBRXZCLFNBQVMsQ0FBQzhFLElBckJSO0FBc0JqQjlCLEVBQUFBLGtCQUFrQixFQUFFaEQsU0FBUyxDQUFDaUY7QUF0QmIsQzs7Z0JBREFuRSxXLGtCQTBCRztBQUNwQkwsRUFBQUEsT0FBTyxFQUFFLEVBRFc7O0FBRXBCOzs7OztBQUtBcUQsRUFBQUEsVUFBVSxFQUFFLEVBUFE7QUFRcEJ2QixFQUFBQSxRQUFRLEVBQUUsb0JBQU0sQ0FBRSxDQVJFO0FBU3BCTSxFQUFBQSxVQUFVLEVBQUUsc0JBQU0sQ0FBRSxDQVRBO0FBVXBCNUIsRUFBQUEsUUFBUSxFQUFFLEVBVlU7QUFXcEI4QyxFQUFBQSxVQUFVLEVBQUVuRCxZQVhRO0FBWXBCVyxFQUFBQSxhQUFhLEVBQUVmLFdBWks7QUFhcEJ3RCxFQUFBQSxXQUFXLEVBQUUsV0FiTztBQWNwQmhCLEVBQUFBLGtCQUFrQixFQUFFO0FBZEEsQzs7U0ExQkhsQyxXIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFJlYWN0LCB7IFB1cmVDb21wb25lbnQgfSBmcm9tICdyZWFjdCdcbmltcG9ydCBQcm9wVHlwZXMgZnJvbSAncHJvcC10eXBlcydcbmltcG9ydCBmdXp6YWxkcmluIGZyb20gJ2Z1enphbGRyaW4tcGx1cydcbmltcG9ydCBWaXJ0dWFsTGlzdCBmcm9tICdyZWFjdC10aW55LXZpcnR1YWwtbGlzdCdcbmltcG9ydCB7IFBhbmUgfSBmcm9tICcuLi8uLi9sYXllcnMnXG5pbXBvcnQgeyBUYWJsZUhlYWQsIFNlYXJjaFRhYmxlSGVhZGVyQ2VsbCB9IGZyb20gJy4uLy4uL3RhYmxlJ1xuaW1wb3J0IE9wdGlvblNoYXBlUHJvcFR5cGUgZnJvbSAnLi9PcHRpb25TaGFwZVByb3BUeXBlJ1xuaW1wb3J0IE9wdGlvbiBmcm9tICcuL09wdGlvbidcblxuLyoqXG4gKiBGdXp6YWxkcmluLXBsdXMgaXMgdGhlIGRlZmF1bHQgZmlsdGVyLCBidXQgeW91IGNhbiB1c2UgeW91ciBvd25cbiAqIGFzIGxvbmcgYXMgdGhleSBmb2xsb3cgdGhlIGZvbGxvd2luZyBzaWduYXR1cmU6XG4gKiBAcGFyYW0gb3B0aW9ucyA8QXJyYXlbU3RyaW5nXT4gLSBbJ2xhYmVsJywgJ2xhYmVsMicsIC4uLl1cbiAqIEBwYXJhbSBpbnB1dCA8U3RyaW5nPlxuICovXG5jb25zdCBmdXp6eUZpbHRlciA9IChvcHRpb25zLCBpbnB1dCkgPT4gZnV6emFsZHJpbi5maWx0ZXIob3B0aW9ucywgaW5wdXQpXG5cbi8qKlxuICogVGhpcyBpcyB0aGUgZGVmYXVsdCBpdGVtIHJlbmRlcmVyIG9mIG9wdGlvbnNcbiAqIHlvdSBjYW4gcGFzcyBjdXN0b20gcmVuZGVyZXJzIGFzIGxvbmcgYXMgdGhleSB3b3JrIHRoZSBzYW1lIGFzIHRoZSBPcHRpb25cbiAqL1xuY29uc3QgaXRlbVJlbmRlcmVyID0gcHJvcHMgPT4gPE9wdGlvbiB7Li4ucHJvcHN9IC8+XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE9wdGlvbnNMaXN0IGV4dGVuZHMgUHVyZUNvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgb3B0aW9uczogUHJvcFR5cGVzLmFycmF5T2YoT3B0aW9uU2hhcGVQcm9wVHlwZSksXG4gICAgY2xvc2U6IFByb3BUeXBlcy5mdW5jLFxuICAgIGhlaWdodDogUHJvcFR5cGVzLm51bWJlcixcbiAgICB3aWR0aDogUHJvcFR5cGVzLm51bWJlcixcblxuICAgIC8qKlxuICAgICAqIFdoZW4gdHJ1ZSwgbXVsdGkgc2VsZWN0IGlzIGFjY291bnRlZCBmb3IuXG4gICAgICovXG4gICAgaXNNdWx0aVNlbGVjdDogUHJvcFR5cGVzLmJvb2wsXG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGhvbGRzIHRoZSB2YWx1ZXMgb2YgdGhlIG9wdGlvbnNcbiAgICAgKi9cbiAgICBzZWxlY3RlZDogUHJvcFR5cGVzLmFycmF5T2YoUHJvcFR5cGVzLnN0cmluZyksXG4gICAgb25TZWxlY3Q6IFByb3BUeXBlcy5mdW5jLFxuICAgIG9uRGVzZWxlY3Q6IFByb3BUeXBlcy5mdW5jLFxuICAgIGhhc0ZpbHRlcjogUHJvcFR5cGVzLmJvb2wsXG4gICAgb3B0aW9uU2l6ZTogUHJvcFR5cGVzLm51bWJlcixcbiAgICByZW5kZXJJdGVtOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBwbGFjZWhvbGRlcjogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBvcHRpb25zRmlsdGVyOiBQcm9wVHlwZXMuZnVuYyxcbiAgICBkZWZhdWx0U2VhcmNoVmFsdWU6IFByb3BUeXBlcy5zdHJpbmdcbiAgfVxuXG4gIHN0YXRpYyBkZWZhdWx0UHJvcHMgPSB7XG4gICAgb3B0aW9uczogW10sXG4gICAgLyoqXG4gICAgICogSW5jbHVkaW5nIGJvcmRlciBib3R0b21cbiAgICAgKiBGb3Igc29tZSByZWFzb24gcGFzc2luZyBoZWlnaHQgdG8gVGFibGVSb3cgZG9lc24ndCB3b3JrXG4gICAgICogVE9ETzogZml4IGhhY2t5IHNvbHV0aW9uXG4gICAgICovXG4gICAgb3B0aW9uU2l6ZTogMzMsXG4gICAgb25TZWxlY3Q6ICgpID0+IHt9LFxuICAgIG9uRGVzZWxlY3Q6ICgpID0+IHt9LFxuICAgIHNlbGVjdGVkOiBbXSxcbiAgICByZW5kZXJJdGVtOiBpdGVtUmVuZGVyZXIsXG4gICAgb3B0aW9uc0ZpbHRlcjogZnV6enlGaWx0ZXIsXG4gICAgcGxhY2Vob2xkZXI6ICdGaWx0ZXIuLi4nLFxuICAgIGRlZmF1bHRTZWFyY2hWYWx1ZTogJydcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByb3BzLCBjb250ZXh0KSB7XG4gICAgc3VwZXIocHJvcHMsIGNvbnRleHQpXG5cbiAgICB0aGlzLnN0YXRlID0ge1xuICAgICAgc2VhcmNoVmFsdWU6IHByb3BzLmRlZmF1bHRTZWFyY2hWYWx1ZSxcbiAgICAgIHNlbGVjdGVkOiBwcm9wcy5zZWxlY3RlZFxuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgIGNvbnN0IHsgaGFzRmlsdGVyIH0gPSB0aGlzLnByb3BzXG4gICAgaWYgKCFoYXNGaWx0ZXIpIHJldHVyblxuICAgIC8qKlxuICAgICAqIEhhY2t5IHNvbHV0aW9uIGZvciBicm9rZW4gYXV0b0ZvY3VzXG4gICAgICogaHR0cHM6Ly9naXRodWIuY29tL3NlZ21lbnRpby9ldmVyZ3JlZW4vaXNzdWVzLzkwXG4gICAgICovXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCgpID0+IHtcbiAgICAgIHRoaXMuc2VhcmNoUmVmLnF1ZXJ5U2VsZWN0b3IoJ2lucHV0JykuZm9jdXMoKVxuICAgIH0pXG5cbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIHRoaXMuaGFuZGxlS2V5RG93bilcbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5oYW5kbGVLZXlEb3duKVxuICB9XG5cbiAgY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcyhuZXh0UHJvcHMpIHtcbiAgICBpZiAobmV4dFByb3BzLnNlbGVjdGVkICE9PSB0aGlzLnN0YXRlLnNlbGVjdGVkKSB7XG4gICAgICB0aGlzLnNldFN0YXRlKHtcbiAgICAgICAgc2VsZWN0ZWQ6IG5leHRQcm9wcy5zZWxlY3RlZFxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBpc1NlbGVjdGVkID0gaXRlbSA9PiB7XG4gICAgY29uc3QgeyBzZWxlY3RlZCB9ID0gdGhpcy5zdGF0ZVxuXG4gICAgcmV0dXJuIEJvb2xlYW4oc2VsZWN0ZWQuZmluZChzZWxlY3RlZEl0ZW0gPT4gc2VsZWN0ZWRJdGVtID09PSBpdGVtLnZhbHVlKSlcbiAgfVxuXG4gIHNlYXJjaCA9IG9wdGlvbnMgPT4ge1xuICAgIGNvbnN0IHsgb3B0aW9uc0ZpbHRlciB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IHsgc2VhcmNoVmFsdWUgfSA9IHRoaXMuc3RhdGVcblxuICAgIHJldHVybiBzZWFyY2hWYWx1ZS50cmltKCkgPT09ICcnXG4gICAgICA/IG9wdGlvbnMgLy8gUmV0dXJuIGlmIG5vIHNlYXJjaCBxdWVyeVxuICAgICAgOiBvcHRpb25zRmlsdGVyKFxuICAgICAgICAgIG9wdGlvbnMubWFwKGl0ZW0gPT4gaXRlbS5sYWJlbEluTGlzdCB8fCBpdGVtLmxhYmVsKSxcbiAgICAgICAgICBzZWFyY2hWYWx1ZVxuICAgICAgICApLm1hcChuYW1lID0+XG4gICAgICAgICAgb3B0aW9ucy5maW5kKGl0ZW0gPT4gaXRlbS5sYWJlbEluTGlzdCA9PT0gbmFtZSB8fCBpdGVtLmxhYmVsID09PSBuYW1lKVxuICAgICAgICApXG4gIH1cblxuICBnZXRDdXJyZW50SW5kZXggPSAoKSA9PiB7XG4gICAgY29uc3QgeyBzZWxlY3RlZCB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdldEZpbHRlcmVkT3B0aW9ucygpXG5cbiAgICByZXR1cm4gb3B0aW9ucy5maW5kSW5kZXgoXG4gICAgICBvcHRpb24gPT4gb3B0aW9uLnZhbHVlID09PSBzZWxlY3RlZFtzZWxlY3RlZC5sZW5ndGggLSAxXVxuICAgIClcbiAgfVxuXG4gIGdldEZpbHRlcmVkT3B0aW9ucygpIHtcbiAgICBjb25zdCB7IG9wdGlvbnMgfSA9IHRoaXMucHJvcHNcblxuICAgIHJldHVybiB0aGlzLnNlYXJjaChvcHRpb25zKVxuICB9XG5cbiAgaGFuZGxlS2V5RG93biA9IGUgPT4ge1xuICAgIGlmIChlLmtleUNvZGUgPT09IDM4KSB7XG4gICAgICB0aGlzLmhhbmRsZUFycm93VXAoKVxuICAgIH1cblxuICAgIGlmIChlLmtleUNvZGUgPT09IDQwKSB7XG4gICAgICB0aGlzLmhhbmRsZUFycm93RG93bigpXG4gICAgfVxuXG4gICAgaWYgKGUua2V5Q29kZSA9PT0gMTMpIHtcbiAgICAgIHRoaXMuaGFuZGxlRW50ZXIoKVxuICAgIH1cbiAgfVxuXG4gIGhhbmRsZUFycm93VXAgPSAoKSA9PiB7XG4gICAgY29uc3QgeyBvblNlbGVjdCB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdldEZpbHRlcmVkT3B0aW9ucygpXG5cbiAgICBsZXQgbmV4dEluZGV4ID0gdGhpcy5nZXRDdXJyZW50SW5kZXgoKSAtIDFcblxuICAgIGlmIChuZXh0SW5kZXggPCAwKSB7XG4gICAgICBuZXh0SW5kZXggPSBvcHRpb25zLmxlbmd0aCAtIDFcbiAgICB9XG5cbiAgICBvblNlbGVjdChvcHRpb25zW25leHRJbmRleF0pXG4gIH1cblxuICBoYW5kbGVBcnJvd0Rvd24gPSAoKSA9PiB7XG4gICAgY29uc3QgeyBvblNlbGVjdCB9ID0gdGhpcy5wcm9wc1xuICAgIGNvbnN0IG9wdGlvbnMgPSB0aGlzLmdldEZpbHRlcmVkT3B0aW9ucygpXG5cbiAgICBsZXQgbmV4dEluZGV4ID0gdGhpcy5nZXRDdXJyZW50SW5kZXgoKSArIDFcblxuICAgIGlmIChuZXh0SW5kZXggPT09IG9wdGlvbnMubGVuZ3RoKSB7XG4gICAgICBuZXh0SW5kZXggPSAwXG4gICAgfVxuXG4gICAgb25TZWxlY3Qob3B0aW9uc1tuZXh0SW5kZXhdKVxuICB9XG5cbiAgaGFuZGxlRW50ZXIgPSAoKSA9PiB7XG4gICAgY29uc3QgaXNTZWxlY3RlZCA9IHRoaXMuZ2V0Q3VycmVudEluZGV4KCkgIT09IC0xXG5cbiAgICBpZiAoaXNTZWxlY3RlZCkge1xuICAgICAgdGhpcy5wcm9wcy5jbG9zZSgpXG4gICAgfVxuICB9XG5cbiAgaGFuZGxlQ2hhbmdlID0gc2VhcmNoVmFsdWUgPT4ge1xuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgc2VhcmNoVmFsdWVcbiAgICB9KVxuICB9XG5cbiAgaGFuZGxlU2VsZWN0ID0gaXRlbSA9PiB7XG4gICAgdGhpcy5wcm9wcy5vblNlbGVjdChpdGVtKVxuICB9XG5cbiAgaGFuZGxlRGVzZWxlY3QgPSBpdGVtID0+IHtcbiAgICB0aGlzLnByb3BzLm9uRGVzZWxlY3QoaXRlbSlcbiAgfVxuXG4gIGFzc2lnblNlYXJjaFJlZiA9IHJlZiA9PiB7XG4gICAgdGhpcy5zZWFyY2hSZWYgPSByZWZcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7XG4gICAgICBvcHRpb25zOiBvcmlnaW5hbE9wdGlvbnMsXG4gICAgICBjbG9zZSxcbiAgICAgIHdpZHRoLFxuICAgICAgaGVpZ2h0LFxuICAgICAgb25TZWxlY3QsXG4gICAgICBvbkRlc2VsZWN0LFxuICAgICAgc2VsZWN0ZWQsXG4gICAgICBoYXNGaWx0ZXIsXG4gICAgICBvcHRpb25TaXplLFxuICAgICAgcmVuZGVySXRlbSxcbiAgICAgIHBsYWNlaG9sZGVyLFxuICAgICAgb3B0aW9uc0ZpbHRlcixcbiAgICAgIGlzTXVsdGlTZWxlY3QsXG4gICAgICBkZWZhdWx0U2VhcmNoVmFsdWUsXG4gICAgICAuLi5wcm9wc1xuICAgIH0gPSB0aGlzLnByb3BzXG4gICAgY29uc3Qgb3B0aW9ucyA9IHRoaXMuc2VhcmNoKG9yaWdpbmFsT3B0aW9ucylcbiAgICBjb25zdCBsaXN0SGVpZ2h0ID0gaGVpZ2h0IC0gKGhhc0ZpbHRlciA/IDMyIDogMClcbiAgICBjb25zdCBjdXJyZW50SW5kZXggPSB0aGlzLmdldEN1cnJlbnRJbmRleCgpXG4gICAgY29uc3Qgc2Nyb2xsVG9JbmRleCA9IGN1cnJlbnRJbmRleCA9PT0gLTEgPyAwIDogY3VycmVudEluZGV4XG5cbiAgICByZXR1cm4gKFxuICAgICAgPFBhbmVcbiAgICAgICAgaGVpZ2h0PXtoZWlnaHR9XG4gICAgICAgIHdpZHRoPXt3aWR0aH1cbiAgICAgICAgZGlzcGxheT1cImZsZXhcIlxuICAgICAgICBmbGV4RGlyZWN0aW9uPVwiY29sdW1uXCJcbiAgICAgICAgey4uLnByb3BzfVxuICAgICAgPlxuICAgICAgICB7aGFzRmlsdGVyICYmIChcbiAgICAgICAgICA8VGFibGVIZWFkPlxuICAgICAgICAgICAgPFNlYXJjaFRhYmxlSGVhZGVyQ2VsbFxuICAgICAgICAgICAgICBvbkNoYW5nZT17dGhpcy5oYW5kbGVDaGFuZ2V9XG4gICAgICAgICAgICAgIGlubmVyUmVmPXt0aGlzLmFzc2lnblNlYXJjaFJlZn1cbiAgICAgICAgICAgICAgYm9yZGVyUmlnaHQ9e251bGx9XG4gICAgICAgICAgICAgIGhlaWdodD17MzJ9XG4gICAgICAgICAgICAvPlxuICAgICAgICAgIDwvVGFibGVIZWFkPlxuICAgICAgICApfVxuICAgICAgICA8UGFuZSBmbGV4PXsxfT5cbiAgICAgICAgICA8VmlydHVhbExpc3RcbiAgICAgICAgICAgIGhlaWdodD17bGlzdEhlaWdodH1cbiAgICAgICAgICAgIHdpZHRoPVwiMTAwJVwiXG4gICAgICAgICAgICBpdGVtU2l6ZT17b3B0aW9uU2l6ZX1cbiAgICAgICAgICAgIGl0ZW1Db3VudD17b3B0aW9ucy5sZW5ndGh9XG4gICAgICAgICAgICBvdmVyc2NhbkNvdW50PXsyMH1cbiAgICAgICAgICAgIHNjcm9sbFRvQWxpZ25tZW50PVwiYXV0b1wiXG4gICAgICAgICAgICB7Li4uKHNjcm9sbFRvSW5kZXhcbiAgICAgICAgICAgICAgPyB7XG4gICAgICAgICAgICAgICAgICBzY3JvbGxUb0luZGV4XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICA6IHt9KX1cbiAgICAgICAgICAgIHJlbmRlckl0ZW09eyh7IGluZGV4LCBzdHlsZSB9KSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBvcHRpb25zW2luZGV4XVxuICAgICAgICAgICAgICBjb25zdCBpc1NlbGVjdGVkID0gdGhpcy5pc1NlbGVjdGVkKGl0ZW0pXG4gICAgICAgICAgICAgIHJldHVybiByZW5kZXJJdGVtKHtcbiAgICAgICAgICAgICAgICBrZXk6IGl0ZW0udmFsdWUsXG4gICAgICAgICAgICAgICAgbGFiZWw6IGl0ZW0ubGFiZWwsXG4gICAgICAgICAgICAgICAgc3R5bGUsXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiBvcHRpb25TaXplLFxuICAgICAgICAgICAgICAgIG9uU2VsZWN0OiAoKSA9PiB0aGlzLmhhbmRsZVNlbGVjdChpdGVtKSxcbiAgICAgICAgICAgICAgICBvbkRlc2VsZWN0OiAoKSA9PiB0aGlzLmhhbmRsZURlc2VsZWN0KGl0ZW0pLFxuICAgICAgICAgICAgICAgIGlzU2VsZWN0YWJsZTogIWlzU2VsZWN0ZWQgfHwgaXNNdWx0aVNlbGVjdCxcbiAgICAgICAgICAgICAgICBpc1NlbGVjdGVkXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9fVxuICAgICAgICAgIC8+XG4gICAgICAgIDwvUGFuZT5cbiAgICAgIDwvUGFuZT5cbiAgICApXG4gIH1cbn1cbiJdfQ==